<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout">
<head>
    <title>TPM</title>
</head>
<body>
<section layout:fragment="header">
    <h1>TPM/h1>
    <ol class="breadcrumb">
        <li><a href="/"><i class="fa fa-dashboard"></i> Tpm</a></li>
        <li class="active">Report</li>
    </ol>
</section>
<div layout:fragment="content">
    <div class="box">
        <div class="box-header with-border">
            <h3 class="box-title">Report</h3>
            <div class="box-tools pull-right">
                <a href="/tpm/list" type="button" class="btn btn-box-tool"><i class="fa fa-list-ul"></i></a>
            </div>
        </div>
        <form data-toggle="validator" role="form"  th:object="${reqDto}" th:action="@{/tpm/saveDetails}" method="post" name="myForm">
            <div class="box-body">
            	<input hidden="hidden" th:field="*{reqHeader.id}">
            	<input hidden="hidden" th:field="*{reqHeader.erhDistrubutor}">
            	<input hidden="hidden" th:field="*{reqHeader.erhConductedOn}" th:value="*{#dates.format(reqHeader.erhConductedOn, 'dd/MM/yyyy')}">
                <table  class="table table-bordered">
                	<tr>
                		<th>User Name</th>
                		<td th:text="*{reqHeader.id}"></td>
                		<th>Date of TPM</th>
                		<td th:text="*{#dates.format(reqHeader.erhConductedOn, 'dd/MM/yyyy')}"></td>
                	</tr>
                	<tr>
                		<th>Distributor Code</th>
                		<td th:text="*{reqHeader.erhDistrubutor}"></td>
                		<th>Retailer/Dealer name</th>
                		<td></td>
                	</tr>
                	<tr>
                		<th>COST INCURED (F&B and others);</th>
                		<td><input type="text" required="true" class="form-control" th:field="*{costIncured}" id="costIncured" /></td> 
                	</tr>
                </table>
                <!-- <textarea th:field="*{recordedText}" cols=100 placeholder="click on speak icon"></textarea> -->
                <textarea cols=100 th:field="*{recordedText}" id="note-textarea" placeholder="click on speak icon to start voice recognition." rows="6"></textarea>
                <p id="recording-instructions"></p>
                
                <i id="start-record-btn" class="fa fa-microphone" style="color: white;padding: 10px;background: #87bf54;border-radius: 50%;"></i>
                <i id="pause-record-btn" class="fa fa-pause" style="color: white;padding: 10px;background: #de8d5d;border-radius: 50%;"></i>
    			<table  class="table table-bordered">
                	<tr>
                		<th>Name Of Plumber</th>
                		<th>Contact No</th>
                		<th>D.O.B</th>
                		<th>D.O.A</th>
                		<th></th>
                	</tr>
                	 <tr th:if="${reqDto.ezcRequestItems.empty}">
            			<td colspan="2"> No Items Added </td>
       			   </tr>
                	<tr th:each="row, itemStat : ${reqDto.ezcRequestItems}">
						<td><input type="text" th:field="${reqDto.ezcRequestItems[__${itemStat.index}__].eriPlumberName}" /></td>
						<td><input type="text" th:field="${reqDto.ezcRequestItems[__${itemStat.index}__].eriContact}" /></td>
						<td>
							<div class="input-group date">
							<div class="input-group-addon">
							<i class="fa fa-calendar"></i>
							</div>
							<input type="text" class="datePickObj form-control pull-right" th:field="${reqDto.ezcRequestItems[__${itemStat.index}__].eriDob}">
							</div>
						</td>
						<td>
							<div class="input-group date">
							<div class="input-group-addon">
							<i class="fa fa-calendar"></i>
							</div>
							<input type="text"  class="datePickObj form-control pull-right" th:field="${reqDto.ezcRequestItems[__${itemStat.index}__].eriDoa}">
							</div>
						</td>
                		<td>
                			<i class="fa fa-trash deleteItem"></i>
                		</td>
                	</tr>
                </table>
            </div>
            <div class="box-footer">
                <button type="button" onclick="addNewItem()" class="btn btn-primary"><i class="fa fa-plus"></i>&nbsp;Add Item</button>
                <button type="button" onclick="addItem()" class="btn btn-primary"><i class="fa fa-arrow-circle-right"></i>&nbsp;Process Voice Data</button>
                <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i>&nbsp;Save</button>
            </div>
        </form>
    </div>
</div>
<div layout:fragment="scriptContent">
<script type="text/javascript">
 $('.datePickObj').datepicker({
      autoclose: true,
      format: 'dd/mm/yyyy'
    })
    $('.deleteItem').click(function(){
    	$(this).closest("tr").remove();
    })
     				

    function addItem()
    {
	 	document.myForm.action ="/tpm/processSpeech";
	 	document.myForm.submit();
    }
	 function addNewItem()
	 {
		 	document.myForm.action ="/tpm/addNewItem";
		 	document.myForm.submit();
	 }
 
 try {
	  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	  var recognition = new SpeechRecognition();
	}
	catch(e) {
	  console.error(e);
	  $('.no-browser-support').show();
	  $('.app').hide();
	}


	var noteTextarea = $('#note-textarea');
	var instructions = $('#recording-instructions');

	var noteContent = '';

	/*-----------------------------
	      Voice Recognition 
	------------------------------*/

	// If false, the recording will stop after a few seconds of silence.
	// When true, the silence period is longer (about 15 seconds),
	// allowing us to keep recording even when the user pauses. 
	recognition.continuous = true;

	// This block is called every time the Speech APi captures a line. 
	recognition.onresult = function(event) {

	  // event is a SpeechRecognitionEvent object.
	  // It holds all the lines we have captured so far. 
	  // We only need the current one.
	  var current = event.resultIndex;

	  // Get a transcript of what was said.
	  var transcript = event.results[current][0].transcript;

	  // Add the current transcript to the contents of our Note.
	  // There is a weird bug on mobile, where everything is repeated twice.
	  // There is no official solution so far so we have to handle an edge case.
	  var mobileRepeatBug = (current == 1 && transcript == event.results[0][0].transcript);

	  if(!mobileRepeatBug) {
	    noteContent += transcript;
	    noteTextarea.val(noteContent);
	  }
	};

	recognition.onstart = function() { 
	  instructions.text('Voice recognition activated. Try speaking into the microphone.');
	}

	recognition.onspeechend = function() {
	  instructions.text('You were quiet for a while so voice recognition turned itself off.');
	}

	recognition.onerror = function(event) {
	  if(event.error == 'no-speech') {
	    instructions.text('No speech was detected. Try again.');  
	  };
	}



	/*-----------------------------
	      App buttons and input 
	------------------------------*/

	$('#start-record-btn').on('click', function(e) {
	  if (noteContent.length) {
	    noteContent += ' ';
	  }
	  recognition.start();
	});


	$('#pause-record-btn').on('click', function(e) {
	  recognition.stop();
	  instructions.text('Voice recognition paused.');
	});

	// Sync the text inside the text area with the noteContent variable.
	noteTextarea.on('input', function() {
	  noteContent = $(this).val();
	})

 

	</script>
</div>
</body>
</html>